name: eventsec

# =========================
# Shared defaults (anchors)
# =========================
x-logging: &default_logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-restart: &default_restart
  restart: unless-stopped

# Common healthcheck timings (override per service if needed)
x-hc-defaults: &hc_defaults
  interval: 10s
  timeout: 5s
  retries: 10
  start_period: 20s

services:
  opensearch:
    healthcheck:
      # Single-node can legitimately stay yellow (no replica allocation).
      # We wait for status=yellow so ingestion/search is usable.
      test:
        [
          "CMD-SHELL",
          "command -v curl >/dev/null 2>&1 || (echo 'curl not found in opensearch image; consider custom image adding curl' >&2; exit 1); curl -sSf 'http://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=2s' >/dev/null",
        ]
      <<: *hc_defaults
      start_period: 30s
    image: opensearchproject/opensearch:2.12.0
    environment:
      discovery.type: single-node
      plugins.security.disabled: "true"
      OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx512m"
      OPENSEARCH_INITIAL_ADMIN_PASSWORD: "${OPENSEARCH_INITIAL_ADMIN_PASSWORD:-EventSec-Admin123!}"
      bootstrap.memory_lock: "true"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    ports:
      - "9200:9200"
    volumes:
      - eventsec_os_data:/usr/share/opensearch/data
    <<: *default_restart
    logging: *default_logging
    networks:
      - internal

  db:
    image: postgres:15
    environment:
      POSTGRES_DB: eventsec
      POSTGRES_USER: eventsec
      POSTGRES_PASSWORD: eventsec
    ports:
      - "5432:5432"
    volumes:
      - eventsec_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U eventsec -d eventsec -h localhost"]
      <<: *hc_defaults
      start_period: 20s
    <<: *default_restart
    logging: *default_logging
    networks:
      - internal

  migrate:
    image: eventsec_enterprise_fixed-backend:latest
    build:
      context: ./backend
      dockerfile: Dockerfile.backend
    environment:
      DATABASE_URL: postgresql+psycopg2://eventsec:eventsec@db:5432/eventsec
      PYTHONPATH: /app
    depends_on:
      db:
        condition: service_healthy
    entrypoint: ["/app/scripts/migrate.sh"]
    restart: "no"
    logging: *default_logging
    networks:
      - internal

  backend:
    image: eventsec_enterprise_fixed-backend:latest
    build:
      context: ./backend
      dockerfile: Dockerfile.backend
    environment:
      DATABASE_URL: postgresql+psycopg2://eventsec:eventsec@db:5432/eventsec
      OPENSEARCH_URL: http://opensearch:9200
      VULN_INTEL_WORKER_ROLE: api
      SERVER_HTTPS_ENABLED: "${SERVER_HTTPS_ENABLED:-false}"
      SERVER_SSL_CERTFILE: "${SERVER_SSL_CERTFILE:-/certs/server.crt}"
      SERVER_SSL_KEYFILE: "${SERVER_SSL_KEYFILE:-/certs/server.key}"
      SERVER_SSL_CA_FILE: "${SERVER_SSL_CA_FILE:-}"
      SERVER_SSL_CLIENT_CERT_REQUIRED: "${SERVER_SSL_CLIENT_CERT_REQUIRED:-false}"
      EVENTSEC_AGENT_TOKEN: "${EVENTSEC_AGENT_TOKEN:-eventsec-dev-token}"
      EVENTSEC_SEED: "${EVENTSEC_SEED:-1}"
      PYTHONPATH: /app
      SERVER_HOST: "0.0.0.0"
    depends_on:
      db:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
      opensearch:
        condition: service_healthy
    ports:
      - "8000:8000"
    volumes:
      - ./infra/certs:/certs:ro
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/readyz', timeout=2).read()\"",
        ]
      <<: *hc_defaults
      start_period: 60s
    <<: *default_restart
    logging: *default_logging
    networks:
      - public
      - internal

  vuln_worker:
    container_name: eventsec_vuln_worker
    image: eventsec_enterprise_fixed-backend:latest
    depends_on:
      db:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    environment:
      DATABASE_URL: postgresql+psycopg2://eventsec:eventsec@db:5432/eventsec
      OPENSEARCH_URL: http://opensearch:9200
      VULN_INTEL_WORKER_ROLE: worker
      PYTHONPATH: /app
    entrypoint: ["python", "-m", "app.worker"]
    <<: *default_restart
    logging: *default_logging
    networks:
      - internal

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.frontend
    depends_on:
      backend:
        # Dev UX: allow frontend to start even if backend isn't healthy yet.
        condition: service_started
    ports:
      - "5173:5173"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"const http=require('http');const req=http.get('http://localhost:5173/',res=>{const ok=res.statusCode>=200 && res.statusCode<500;process.exit(ok?0:1)});req.on('error',()=>process.exit(1));\"",
        ]
      <<: *hc_defaults
      start_period: 20s
    <<: *default_restart
    logging: *default_logging
    networks:
      - public

  retention:
    image: eventsec_enterprise_fixed-backend:latest
    depends_on:
      backend:
        condition: service_healthy
      db:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
      opensearch:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql+psycopg2://eventsec:eventsec@db:5432/eventsec
      OPENSEARCH_URL: http://opensearch:9200
      PYTHONPATH: /app
    entrypoint:
      [
        "python",
        "-m",
        "app.maintenance",
        "--days",
        "${RETENTION_DAYS:-30}",
        "--loop-seconds",
        "86400",
      ]
    <<: *default_restart
    logging: *default_logging
    networks:
      - internal

  email_protection:
    build:
      context: ./email_protection
      dockerfile: Dockerfile
    env_file:
      - ./email_protection/.env.example
    ports:
      - "8100:8100"
    depends_on:
      backend:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import socket; s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1',8100)); s.close()\"",
        ]
      <<: *hc_defaults
      start_period: 20s
    <<: *default_restart
    logging: *default_logging
    networks:
      - public
      - internal

  scanner:
    build:
      context: ./protoxol_triage_package
      dockerfile: Dockerfile
    profiles:
      - scanner
    volumes:
      - ./scanner_out:/app/triage_out
    entrypoint: ["sleep", "infinity"]
    networks:
      - internal

  suricata:
    image: jasonish/suricata:7.0.3
    profiles:
      - ids
    command: ["-c", "/etc/suricata/suricata.yaml", "-i", "eth0"]
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_NICE
    volumes:
      - ./sensors/suricata/suricata.yaml:/etc/suricata/suricata.yaml:ro
      - ./sensors/suricata/rules/local.rules:/etc/suricata/rules/local.rules:ro
      - suricata_logs:/var/log/suricata
    # NOTE: For real packet capture on Linux host, you may need:
    # network_mode: host
    # cap_add: [NET_ADMIN, NET_RAW]
    # On macOS Docker Desktop, host networking differs; document limitations.
    <<: *default_restart
    logging: *default_logging
    networks:
      - internal

  zeek:
    image: zeek/zeek:6.2.1
    profiles:
      - ids
    command: ["zeek", "-C", "-i", "eth0", "local.zeek"]
    volumes:
      - ./sensors/zeek/local.zeek:/usr/local/zeek/share/zeek/site/local.zeek:ro
      - zeek_logs:/var/log/zeek
    <<: *default_restart
    logging: *default_logging
    networks:
      - internal

  ids_collector:
    build:
      context: ./sensors/collector
      dockerfile: Dockerfile
    profiles:
      - ids
    environment:
      EVENTSEC_API_BASE: http://backend:8000
      EVENTSEC_INGEST_TOKEN: "${EVENTSEC_AGENT_TOKEN:-eventsec-dev-token}"
      SENSOR_NAME: "docker-ids"
      SENSOR_LOCATION: "compose"
      SURICATA_EVE_PATH: /var/log/suricata/eve.json
      ZEEK_LOG_DIR: /var/log/zeek
    depends_on:
      backend:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    volumes:
      - suricata_logs:/var/log/suricata:ro
      - zeek_logs:/var/log/zeek:ro
      - collector_state:/state
    <<: *default_restart
    logging: *default_logging
    networks:
      - internal

volumes:
  eventsec_db_data:
  eventsec_os_data:
  suricata_logs:
  zeek_logs:
  collector_state:

networks:
  public:
    name: eventsec_public
  internal:
    name: eventsec_internal
    internal: true
