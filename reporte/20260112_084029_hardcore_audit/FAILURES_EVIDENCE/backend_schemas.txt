from datetime import date, datetime
from enum import Enum
from typing import Any, Dict, List, Literal, Optional

from pydantic import BaseModel


AlertStatus = Literal["open", "in_progress", "closed"]
AlertSeverity = Literal["low", "medium", "high", "critical"]


class AlertBase(BaseModel):
    title: str
    description: str
    source: str
    category: str
    severity: AlertSeverity = "medium"
    url: Optional[str] = None
    sender: Optional[str] = None
    username: Optional[str] = None
    hostname: Optional[str] = None


class AlertCreate(AlertBase):
    pass


class AlertUpdate(BaseModel):
    status: Optional[AlertStatus] = None
    assigned_to: Optional[int] = None
    conclusion: Optional[str] = None


class Alert(AlertBase):
    id: int
    status: AlertStatus = "open"
    created_at: Optional[datetime] = None
    updated_at: Optional[datetime] = None
    assigned_to: Optional[int] = None
    conclusion: Optional[str] = None

    class Config:
        from_attributes = True


PasswordGuardAction = Literal[
    "DETECTED",
    "USER_APPROVED_ROTATION",
    "USER_DENIED_ROTATION",
    "ROTATED",
]


class PasswordGuardEventBase(BaseModel):
    host_id: str
    user: str
    entry_id: str
    entry_label: str
    exposure_count: int
    action: PasswordGuardAction
    timestamp: datetime
    client_version: str


class PasswordGuardEventCreate(PasswordGuardEventBase):
    class Config:
        json_schema_extra = {
            "examples": [
                {
                    "host_id": "workstation-12",
                    "user": "alice",
                    "entry_id": "vault-42",
                    "entry_label": "Okta Admin",
                    "exposure_count": 21234,
                    "action": "DETECTED",
                    "timestamp": "2025-03-20T10:12:04Z",
                    "client_version": "0.1.0",
                }
            ]
        }


class PasswordGuardEvent(PasswordGuardEventBase):
    id: int
    tenant_id: str
    alert_id: Optional[int] = None
    created_at: datetime
    updated_at: datetime

    class Config:
        from_attributes = True


class PasswordGuardAlert(BaseModel):
    alert: Alert
    event: Optional[PasswordGuardEvent] = None


class HandoverBase(BaseModel):
    shift_start: datetime
    shift_end: datetime
    alerts_summary: str = ""
    notes_to_next_shift: str = ""
    links: Optional[List[Dict[str, Any]]] = None


class HandoverCreate(HandoverBase):
    analyst_user_id: Optional[int] = None


class HandoverUpdate(BaseModel):
    shift_start: Optional[datetime] = None
    shift_end: Optional[datetime] = None
    analyst_user_id: Optional[int] = None
    alerts_summary: Optional[str] = None
    notes_to_next_shift: Optional[str] = None
    links: Optional[List[Dict[str, Any]]] = None


class Handover(HandoverBase):
    id: int
    analyst_user_id: Optional[int] = None
    created_by: Optional[int] = None
    created_at: datetime
    updated_at: datetime

    class Config:
        from_attributes = True


class UserProfile(BaseModel):
    id: int
    full_name: str
    role: str
    email: str
    avatar_url: Optional[str] = None
    timezone: str = "Europe/Madrid"
    tenant_id: Optional[str] = None
    team: Optional[str] = None
    manager: Optional[str] = None
    computer: Optional[str] = None
    mobile_phone: Optional[str] = None

    class Config:
        from_attributes = True


class UserRole(str, Enum):
    ADMIN = "admin"
    TEAM_LEAD = "team_lead"
    ANALYST = "analyst"
    SENIOR_ANALYST = "senior_analyst"


class UserCreate(BaseModel):
    full_name: str
    role: str
    email: str
    password: str
    tenant_id: Optional[str] = None
    team: Optional[str] = None
    manager: Optional[str] = None
    computer: Optional[str] = None
    mobile_phone: Optional[str] = None
    timezone: str = "Europe/Madrid"


class UserUpdate(BaseModel):
    full_name: Optional[str] = None
    role: Optional[str] = None
    email: Optional[str] = None
    tenant_id: Optional[str] = None
    team: Optional[str] = None
    manager: Optional[str] = None
    computer: Optional[str] = None
    mobile_phone: Optional[str] = None
    timezone: Optional[str] = None


class LoginRequest(BaseModel):
    email: str
    password: str


class LoginResponse(BaseModel):
    access_token: str
    token_type: str = "bearer"
    user: UserProfile


class AgentBase(BaseModel):
    name: str
    os: str
    ip_address: str
    version: Optional[str] = None
    tags: List[str] = []


class Agent(AgentBase):
    id: int
    status: str
    last_heartbeat: Optional[datetime] = None
    last_seen: Optional[datetime] = None
    last_ip: Optional[str] = None

    class Config:
        from_attributes = True


class SoftwareComponentIngestItem(BaseModel):
    name: str
    version: str
    vendor: Optional[str] = None
    source: Optional[str] = None
    purl: Optional[str] = None
    cpe: Optional[str] = None
    raw: Optional[Dict[str, Any]] = None


class SoftwareInventoryIngestRequest(BaseModel):
    collected_at: Optional[datetime] = None
    items: List[SoftwareComponentIngestItem]


class SoftwareComponent(BaseModel):
    id: int
    tenant_id: str
    asset_id: int
    name: str
    version: str
    vendor: Optional[str] = None
    source: Optional[str] = None
    purl: Optional[str] = None
    cpe: Optional[str] = None
    raw: Optional[Dict[str, Any]] = None
    collected_at: datetime
    last_seen_at: datetime

    class Config:
        from_attributes = True


class VulnerabilityRecord(BaseModel):
    id: int
    source: str
    cve_id: Optional[str] = None
    osv_id: Optional[str] = None
    title: Optional[str] = None
    summary: Optional[str] = None
    cvss_score: Optional[float] = None
    cvss_vector: Optional[str] = None
    epss_score: Optional[float] = None
    kev: bool = False
    published_at: Optional[datetime] = None
    modified_at: Optional[datetime] = None
    references: Optional[Dict[str, Any]] = None

    class Config:
        from_attributes = True

