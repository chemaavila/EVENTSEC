#!/usr/bin/env bash
set -euo pipefail

API_BASE_URL="${API_BASE_URL:-http://localhost:8000}"
ADMIN_EMAIL="${ADMIN_EMAIL:-admin@example.com}"
ADMIN_PASSWORD="${ADMIN_PASSWORD:-Admin123!}"

token="$(
  curl -fsS "${API_BASE_URL}/auth/login" \
    -H "Content-Type: application/json" \
    -d "{\"email\":\"${ADMIN_EMAIL}\",\"password\":\"${ADMIN_PASSWORD}\"}" \
  | python -c 'import json,sys; print(json.load(sys.stdin)["access_token"])'
)"

auth_header="Authorization: Bearer ${token}"

endpoint_id="$(
  curl -fsS "${API_BASE_URL}/endpoints" -H "${auth_header}" \
  | python -c 'import json,sys; data=json.load(sys.stdin); print(data[0]["id"] if data else "")'
)"

if [ -z "${endpoint_id}" ]; then
  echo "[smoke] no endpoints found" >&2
  exit 1
fi

action_id="$(
  curl -fsS "${API_BASE_URL}/endpoints/${endpoint_id}/actions" \
    -H "${auth_header}" \
    -H "Content-Type: application/json" \
    -d '{"action_type":"malware_scan","parameters":{"path":"DEFAULT","recursive":true,"engine":"auto","timeout_seconds":900}}' \
  | python -c 'import json,sys; print(json.load(sys.stdin)["id"])'
)"

echo "[smoke] queued malware_scan action ${action_id}"

deadline=$((SECONDS + 60))
action_status=""
while [ $SECONDS -lt $deadline ]; do
  action_status="$(
    curl -fsS "${API_BASE_URL}/endpoints/${endpoint_id}/actions" -H "${auth_header}" \
    | python -c 'import json,sys; data=json.load(sys.stdin); target=[a for a in data if a.get("id")==int(sys.argv[1])]; print(target[0]["status"] if target else "")' "${action_id}"
  )"
  if [ "${action_status}" == "completed" ] || [ "${action_status}" == "failed" ]; then
    break
  fi
  sleep 2
done

if [ "${action_status}" != "completed" ] && [ "${action_status}" != "failed" ]; then
  echo "[smoke] action did not complete in time" >&2
  exit 1
fi

echo "[smoke] action status: ${action_status}"

edr_event_json="$(curl -fsS "${API_BASE_URL}/edr/events" -H "${auth_header}")"
has_scan="$(
  echo "${edr_event_json}" \
  | python -c 'import json,sys; data=json.load(sys.stdin); print(any(e.get("event_type")=="edr.malware_scan" for e in data))'
)"
if [ "${has_scan}" != "True" ]; then
  echo "[smoke] edr.malware_scan event not found" >&2
  exit 1
fi

infected_count="$(
  echo "${edr_event_json}" \
  | python -c 'import json,sys; data=json.load(sys.stdin); scans=[e for e in data if e.get("event_type")=="edr.malware_scan"]; print(scans[0].get("details", {}).get("infected_count", 0) if scans else 0)'
)"

if [ "${infected_count}" -gt 0 ]; then
  has_alert="$(
    curl -fsS "${API_BASE_URL}/alerts" -H "${auth_header}" \
    | python -c 'import json,sys; data=json.load(sys.stdin); print(any(a.get("source")=="EDR Scanner" for a in data))'
  )"
  if [ "${has_alert}" != "True" ]; then
    echo "[smoke] malware alert not found despite detections" >&2
    exit 1
  fi
fi

echo "[smoke] malware scan smoke check complete"
